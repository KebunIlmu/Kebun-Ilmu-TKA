<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Kebun Ilmu ‚Äî Hasil Try Out</title>

<style>
:root{
  --primary:#0f766e;
  --secondary:#14b8a6;
  --text:#1e293b;
  --muted:#64748b;
  --bg:#f0fdfa;
  --card:#ffffff;
  --radius:16px;
  --shadow:0 8px 24px rgba(0,0,0,0.08);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* ================= HEADER WEB ================= */
header{
  background:#fff;
  box-shadow:var(--shadow);
  padding:12px 20px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
  gap:10px;
  position:sticky;
  top:0;
  z-index:1000;
}
.brand{
  display:flex;
  align-items:center;
  gap:10px;
}
.brand img{
  width:44px;
  height:44px;
  border-radius:12px;
}
.brand-name{
  font-size:20px;
  font-weight:700;
  color:var(--primary);
}
nav{
  display:flex;
  gap:14px;
}
nav a{
  padding:8px 14px;
  border-radius:10px;
  color:var(--muted);
}
nav a:hover{
  background:var(--secondary);
  color:#fff;
}
.btn{
  padding:8px 14px;
  border-radius:10px;
  font-weight:600;
  cursor:pointer;
  border:none;
}
.btn-outline{
  background:transparent;
  border:2px solid var(--primary);
  color:var(--primary);
}

/* ================= CONTENT ================= */
.container{
  max-width:1200px;
  margin:auto;
  padding:30px 16px;
}
.card{
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:20px;
  margin-bottom:30px;
}
h1,h2,h3{
  color:var(--primary);
  margin-top:0;
}

/* ================= TABLE ================= */
.table-wrapper{
  overflow-x:auto;
}
table{
  width:100%;
  border-collapse:collapse;
  min-width:700px;
  font-size:14px;
}
th,td{
  padding:10px;
  border-bottom:1px solid #e2e8f0;
  white-space:nowrap;
}
th{
  background:var(--primary);
  color:#fff;
}
tr:nth-child(even){
  background:#f8fafc;
}

/* ================= INPUT ================= */
input{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:2px solid var(--primary);
  margin-bottom:15px;
}

/* ================= PRINT HEADER ================= */
#printHeader{
  display:none;
  align-items:center;
  gap:16px;
  margin-bottom:20px;
}
#printHeader img{
  width:80px;
}
.print-title h2{
  margin:0;
  font-size:22px;
}
.print-title p{
  margin:4px 0 0;
  font-size:14px;
}

/* ================= PRINT MODE ================= */
@media print {
  body * {
    visibility: hidden;
  }

  .print-area, .print-area * {
    visibility: visible;
  }

  #printHeader, #printHeader * {
    visibility: visible;
  }

  #printHeader{
    display:flex;
  }

  .print-area{
    position:absolute;
    top:120px;
    left:0;
    width:100%;
  }

  header, input, button{
    display:none !important;
  }

  table{
    font-size:12px;
  }
}
/* ===== LOGIN ===== */
#loginForm{
  position:fixed;
  inset:0;
  background:linear-gradient(135deg,#e0f2fe,#ccfbf1);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:9999;
}

.login-box{
  background:#fff;
  width:100%;
  max-width:360px;
  padding:26px;
  border-radius:14px;
  box-shadow:0 10px 30px rgba(0,0,0,.15);
  text-align:center;
}

.login-box h2{
  margin-top:0;
  color:#0f766e;
}

.login-box input{
  width:100%;
  padding:12px;
  margin:10px 0;
  border-radius:10px;
  border:1.5px solid #0f766e;
}

.login-box button{
  width:100%;
  padding:12px;
  background:#0f766e;
  color:#fff;
  border:none;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
}

.login-box button:hover{
  background:#115e59;
}

#errorMsg{
  margin-top:10px;
  color:red;
  font-size:14px;
}

</style>

<!-- ================= FIREBASE ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAY-bJOK6QLFhpi5lQMLGNxsxIe8JNUvpg",
  authDomain: "tryout-kebun-ilmu.firebaseapp.com",
  projectId: "tryout-kebun-ilmu",
  storageBucket: "tryout-kebun-ilmu.firebasestorage.app",
  messagingSenderId: "497636674894",
  appId: "1:497636674894:web:82fb38cb615d8bf7b1a21f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window.addEventListener("DOMContentLoaded", async ()=>{
  const tabelHasil = document.getElementById("tabelHasil");
  const rankingMapel = document.getElementById("rankingMapel");

  const q = query(collection(db,"hasil_ujian"), orderBy("waktu","desc"));
  const snap = await getDocs(q);

  /* ================= TABEL DATA ================= */
  const table = document.createElement("table");
  const h = table.insertRow();
  ["No","NIK","Nama","JK","Tgl Lahir","Sekolah","Mapel","Nilai","Waktu"]
    .forEach(x=>{
      const th=document.createElement("th");
      th.textContent=x;
      h.appendChild(th);
    });

  let no=1;
  const semua=[];

  snap.docs.forEach(doc=>{
    const d=doc.data();
    semua.push(d);

    const r=table.insertRow();
    r.insertCell().textContent=no++;
    r.insertCell().textContent=d.nik||"";
    r.insertCell().textContent=d.nama||"";
    r.insertCell().textContent=d.jk||"";
    r.insertCell().textContent=d.tglLahir||"";
    r.insertCell().textContent=d.sekolah||"";
    r.insertCell().textContent=d.mapel||"";
    r.insertCell().textContent=d.nilai||"";

    let w="";
    if(d.waktu?.seconds){
      w=new Date(d.waktu.seconds*1000).toLocaleString("id-ID");
    }
    r.insertCell().textContent=w;
  });

  tabelHasil.appendChild(table);

  /* ================= RANKING PER MAPEL ================= */
  const grup={};
  semua.forEach(d=>{
    if(!grup[d.mapel]) grup[d.mapel]=[];
    if(!isNaN(d.nilai)) grup[d.mapel].push(d);
  });

  Object.keys(grup).forEach(mapel=>{
    const wrap=document.createElement("div");
    wrap.className="print-area";
    wrap.id="print-"+mapel.replace(/\s+/g,"_");

    const title=document.createElement("h3");
    title.textContent="üìò "+mapel;
    wrap.appendChild(title);

    const actions=document.createElement("div");
    actions.style.display="flex";
    actions.style.gap="10px";
    actions.style.marginBottom="10px";

    const btnPrint=document.createElement("button");
    btnPrint.textContent="üñ® Print Mapel";
    btnPrint.className="btn btn-outline";
    btnPrint.onclick=()=>printMapel(wrap.id);

    const btnCSV=document.createElement("button");
    btnCSV.textContent="‚¨á Download CSV";
    btnCSV.className="btn btn-outline";
    btnCSV.onclick=()=>downloadMapelCSV(mapel);

    actions.appendChild(btnPrint);
    actions.appendChild(btnCSV);
    wrap.appendChild(actions);

    const t=document.createElement("table");
    t.id="table-mapel-"+mapel;

    const hh=t.insertRow();
    ["Rank","Nama","Sekolah","Nilai"].forEach(x=>{
      const th=document.createElement("th");
      th.textContent=x;
      hh.appendChild(th);
    });

    grup[mapel].sort((a,b)=>b.nilai-a.nilai)
      .forEach((d,i)=>{
        const r=t.insertRow();
        r.insertCell().textContent=i+1;
        r.insertCell().textContent=d.nama;
        r.insertCell().textContent=d.sekolah;
        r.insertCell().textContent=d.nilai;
      });

    wrap.appendChild(t);
    rankingMapel.appendChild(wrap);
  });
});

/* ================= UTIL ================= */
window.filterTable=function(){
  const f=document.getElementById("searchInput").value.toLowerCase();
  document.querySelectorAll("#tabelHasil tr").forEach((r,i)=>{
    if(i===0) return;
    r.style.display=r.textContent.toLowerCase().includes(f)?"":"none";
  });
}

window.downloadCSV=function(){
  const rows=document.querySelectorAll("#tabelHasil tr");
  let csv=[];
  rows.forEach(r=>{
    csv.push([...r.children].map(c=>`"${c.textContent}"`).join(","));
  });
  const blob=new Blob([csv.join("\n")],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="hasil_tryout.csv";
  a.click();
}

window.downloadMapelCSV=function(mapel){
  const table=document.getElementById("table-mapel-"+mapel);
  let csv=[];
  table.querySelectorAll("tr").forEach(r=>{
    csv.push([...r.children].map(c=>`"${c.textContent}"`).join(","));
  });
  const blob=new Blob([csv.join("\n")],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="ranking_"+mapel+".csv";
  a.click();
}

window.printMapel=function(id){
  document.querySelectorAll(".print-area").forEach(el=>el.style.display="none");
  document.getElementById(id).style.display="block";
  window.print();
  document.querySelectorAll(".print-area").forEach(el=>el.style.display="block");
}
</script>
</head>

<body>
<!-- ===== LOGIN SCREEN ===== -->
<div id="loginForm">
  <div class="login-box">
    <h2>Login Admin</h2>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()">Masuk</button>
    <p id="errorMsg"></p>
  </div>
</div>

<div id="mainContent" style="display:none;"> 
<!-- HEADER PRINT -->
<div id="printHeader">
  <img src="https://zahwan93.github.io/Kebun-Ilmu-Matematika-SMP/logo.png">
  <div class="print-title">
    <h2>Kebun Ilmu</h2>
    <p>Hasil Try Out & Ranking Per Mapel</p>
  </div>
</div>

<header>
  <div class="brand">
    <img src="https://zahwan93.github.io/Kebun-Ilmu-Matematika-SMP/logo.png">
    <span class="brand-name">Kebun Ilmu</span>
  </div>
  <nav>
    <a href="https://kebunilmu.github.io/Kebun-Ilmu-TKA/home.html" target="_blank">Home</a>
  </nav>
  <button class="btn btn-outline" onclick="downloadCSV()">Download Semua CSV</button>
</header>

<div class="container">
<div class="card">
  <h2>üîë Token Ujian Aktif</h2>

  <div id="tokenAktif" style="
    font-size:36px;
    font-weight:800;
    letter-spacing:6px;
    text-align:center;
    color:var(--primary);
    margin:10px 0;
  ">---</div>

  <div id="info" style="
    text-align:center;
    color:var(--muted);
    margin-bottom:15px;
  "></div>

  <div style="text-align:center;">
    <button class="btn btn-outline" onclick="tampilkanToken()">
      üîÑ Refresh Token
    </button>
  </div>
</div>

  <div class="card">
    <h1>üìä Data Hasil Try Out</h1>
    <input id="searchInput" placeholder="üîç Cari NIK / Nama / Sekolah / Mapel..." onkeyup="filterTable()">
    <div class="table-wrapper">
      <div id="tabelHasil"></div>
    </div>
  </div>

  <div class="card">
    <h2>üèÜ Ranking Per Mapel</h2>
    <div class="table-wrapper">
      <div id="rankingMapel"></div>
    </div>
  </div>
</div>
</div>

<script>
/* ===== TOKEN DINAMIS 10 MENIT ===== */
function getTokenSekarang() {
  const now = new Date();
  const jam = now.getHours();
  const menit = now.getMinutes();

  // Jam aktif ujian
  if (jam < 7 || jam >= 22) return null;

  const slot = Math.floor(menit / 10); // 0‚Äì5
  const seed = jam * 100 + slot;

  const depan = String.fromCharCode(65 + (seed * 7) % 26);

  return `${depan}${jam.toString().padStart(2,'0')}${slot}`;
}

/* ===== TAMPILKAN TOKEN ===== */
function tampilkanToken() {
  const token = getTokenSekarang();
  const el = document.getElementById("tokenAktif");
  const info = document.getElementById("info");

  if (!token) {
    el.innerText = "‚õî";
    info.innerText = "Ujian belum dibuka (07.00 ‚Äì 22.00)";
  } else {
    el.innerText = token;
    info.innerText = "Token berlaku 10 menit";
  }
}

/* auto load + refresh tiap menit */
document.addEventListener("DOMContentLoaded", ()=>{
  tampilkanToken();
  setInterval(tampilkanToken, 60 * 1000);
});
</script>
<script>
const USERS = [
  { username:"admin", password:"admin123", expired:"2026-12-31" },
  { username:"zahwan", password:"132611", expired:"3026-06-30" },
  { username:"MANU9", password:"2026", expired:"2026-07-31" },
{ username:"MTSMH", password:"2026", expired:"2026-07-31" },


];

function login(){
  const u = username.value.trim();
  const p = password.value;
  const err = errorMsg;

  const user = USERS.find(x => x.username===u && x.password===p);
  if(!user){
    err.innerText = "Username atau password salah";
    return;
  }

  const today = new Date();
  const exp = new Date(user.expired + "T23:59:59");
  if(today > exp){
    err.innerText = "Akun sudah kadaluarsa";
    return;
  }

  localStorage.setItem("loginUser", user.username);
  localStorage.setItem("loginExpired", user.expired);

  loginForm.style.display = "none";
  mainContent.style.display = "block";
}

/* AUTO LOGIN */
window.addEventListener("DOMContentLoaded",()=>{
  const u = localStorage.getItem("loginUser");
  const e = localStorage.getItem("loginExpired");
  if(!u || !e) return;

  if(new Date() > new Date(e + "T23:59:59")){
    localStorage.clear();
    return;
  }

  loginForm.style.display="none";
  mainContent.style.display="block";
});
</script>

</body>
</html>
